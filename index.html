<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Green Fugitive</title>
    <style>
        :root {
            --background-color: #121212;
            --text-color: #E0E0E0;
            --accent-color: #4CAF50;
            --button-bg: #272727;
            --button-hover-bg: #383838;
            --font-main: 'Georgia', 'Times New Roman', serif;
            --font-ui: 'Helvetica Neue', 'Arial', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        #game-wrapper {
            max-width: 800px;
            width: 100%;
            border: 1px solid var(--button-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #game-container {
            padding: 2em;
            background-color: rgba(0,0,0,0.2);
        }

        #story-text {
            line-height: 1.8;
            font-size: 1.1em;
            white-space: pre-wrap;
            margin-bottom: 2em;
            min-height: 200px;
        }

        #choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .choice-button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--accent-color);
            padding: 15px;
            font-family: var(--font-main);
            font-size: 1em;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        .choice-button:hover {
            background-color: #333;
            transform: translateX(5px);
        }
        
        #ui-bar {
            background-color: var(--button-bg);
            padding: 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #444;
        }

        .ui-button {
            font-family: var(--font-ui);
            background-color: var(--button-bg);
            color: var(--text-color);
            border: 1px solid #555;
            padding: 8px 15px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .ui-button:hover {
            background-color: var(--button-hover-bg);
        }

        #loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--accent-color);
            font-style: italic;
        }

    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="story-text">Initializing...</div>
            <div id="choices"></div>
            <div id="loading-indicator">The threads of fate are weaving...</div>
        </div>
        <div id="ui-bar">
            <button id="save-button" class="ui-button">Save</button>
            <button id="load-button" class="ui-button">Load</button>
            <button id="restart-button" class="ui-button">Restart</button>
        </div>
    </div>

    <script type="module">
        // --- GAME STATE MANAGEMENT ---
        let gameState = {};

        const initialGameState = {
            character: {
                age: 0,
                gender: '',
            },
            location: 'START',
            secret: {
                type: "The Agricultural Method",
                role: "The Creator",
            },
            menaces: {
                despair: 0,
                paranoia: 0,
                exposure: 0,
            },
            worldState: {
                heat: 5,
                factionReputation: {
                    freeTowns: 0,
                    jackals: 0,
                },
            },
            storyFlags: {},
            inventory: [],
        };

        // --- CORE GAME SYSTEMS ---
        function updateState(changes) {
            if (!changes) return;

            Object.keys(changes).forEach(key => {
                if (key === 'inventory' && typeof changes[key] === 'object') {
                    if (changes[key].addItem && !gameState.inventory.includes(changes[key].addItem)) {
                        gameState.inventory.push(changes[key].addItem);
                    }
                    if (changes[key].removeItem) {
                        gameState.inventory = gameState.inventory.filter(item => item !== changes[key].removeItem);
                    }
                } else if (typeof gameState[key] === 'object' && gameState[key] !== null && !Array.isArray(gameState[key])) {
                    Object.assign(gameState[key], changes[key]);
                } else {
                    gameState[key] = changes[key];
                }
            });
            autoSaveGame();
        }
        
        // --- SAVE/LOAD FUNCTIONALITY ---
        function saveGame() {
            try {
                localStorage.setItem('greenFugitiveSave', JSON.stringify(gameState));
                alert('Game Saved.');
            } catch (error) {
                console.error('Error saving game:', error);
                alert('Could not save game.');
            }
        }

        function autoSaveGame() {
             try {
                localStorage.setItem('greenFugitiveSave_auto', JSON.stringify(gameState));
            } catch (error) {
                console.error('Autosave failed:', error);
            }
        }

        function loadGame(isAuto = false) {
            try {
                const savedState = localStorage.getItem(isAuto ? 'greenFugitiveSave_auto' : 'greenFugitiveSave');
                if (savedState) {
                    gameState = JSON.parse(savedState);
                    if(!isAuto) alert('Game Loaded.');
                    
                    const locationName = formatLocationName(gameState.location);
                    renderNarrative(`Game loaded. You are at: ${locationName}. What do you do?`);
                    renderChoices([{text: "Look around.", action: "Look around"}]);

                } else {
                    if(!isAuto) alert('No saved game found.');
                }
            } catch (error) {
                console.error('Error loading game:', error);
                alert('Could not load saved game. It may be corrupted.');
            }
        }
        
        function restartGame() {
            if (confirm("Are you sure you want to restart? Your progress will be lost.")) {
                localStorage.removeItem('greenFugitiveSave_auto');
                localStorage.removeItem('greenFugitiveSave');
                initializeGame();
            }
        }
        
        // --- HELPER FUNCTIONS ---
        function formatLocationName(locationId) {
            if (!locationId) return "an unknown location";
            return locationId
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }
        
        // --- ROBUST JSON PARSING ---
        function parseJsonResponse(jsonString) {
            const match = jsonString.match(/```json\n([\s\S]*?)\n```/);
            if (match && match[1]) {
                return JSON.parse(match[1]);
            }
            
            const firstBrace = jsonString.indexOf('{');
            const lastBrace = jsonString.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) {
                const potentialJson = jsonString.substring(firstBrace, lastBrace + 1);
                return JSON.parse(potentialJson);
            }

            throw new Error("Could not find a valid JSON block in the AI's response.");
        }

        // --- GEMINI API INTERACTION ---
        async function getAiResponse(prompt) {
            const response = await fetch('/.netlify/functions/gemini-proxy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Serverless proxy error:", errorText);
                throw new Error(`Game server error: ${response.statusText}`);
            }

            const data = await response.json();
            return data.text; // Return the raw text from the proxy
        }

        async function handlePlayerAction(action) {
            toggleLoading(true);

            const contextPacket = `
                ---
                Game State Context:
                Character: ${gameState.character.age}-year-old ${gameState.character.gender}.
                Location: ${formatLocationName(gameState.location)}.
                Inventory: ${gameState.inventory.join(', ') || 'empty'}.
                ---
            `;
            
            try {
                // --- API CALL 1: Get the narrative text ---
                let narrativePrompt;
                if (action === 'INITIALIZE_GAME') {
                    const startLocation = startLocations[Math.floor(Math.random() * startLocations.length)];
                    updateState({ location: startLocation.id });
                    narrativePrompt = `
                        Persona: You are a terse, action-focused narrator for a survival horror game.
                        Task: Write a 2-3 sentence opening scene that throws the player directly into a choice. The player's lab is being raided by soldiers from 'The Authority'.
                        Context: The lab is a ${startLocation.text}. The player is a ${gameState.character.age}-year-old scientist. They hear soldiers' boots and shouting getting closer. On a desk in front of them are their 'encrypted research notes' and a 'survival go-bag'. There's only time to grab one.
                        Format: Plain text only.
                    `;
                } else {
                    narrativePrompt = `
                        Persona: You are a tense, literary narrator.
                        Task: Narrate the outcome of the player's action.
                        Context: The player chose to '${action}'.
                        ${contextPacket}
                        Format: Plain text only.
                    `;
                }

                const narrativeText = await getAiResponse(narrativePrompt);
                renderNarrative(narrativeText);
                
                // --- API CALL 2: Get the state changes and choices ---
                const choicesPrompt = `
                    Persona: You are a game logic AI.
                    Task: Based on the following narrative text, determine the consequences and what the player can do next.
                    Narrative context: "${narrativeText}"
                    ${contextPacket}
                    Format: YOU MUST respond with a single, minified JSON object with two keys: "stateChanges" (an object with updates to location, menaces, heat, inventory, etc.) and "choices" (an array of two distinct choice objects, each with "text" and "action" keys). DO NOT provide a "Continue..." choice.
                    Example Response: {"stateChanges":{"inventory":{"addItem":"Encrypted Research Notes"}},"choices":[{"text":"Run for the service door.","action":"Escape through the service door"},{"text":"Smash the window and jump.","action":"Escape through the window"}]}
                `;
                
                const choicesJson = await getAiResponse(choicesPrompt);
                const aiResponse = parseJsonResponse(choicesJson);

                if (!aiResponse || !aiResponse.choices) {
                    throw new Error("AI response was missing the 'choices' field.");
                }

                updateState(aiResponse.stateChanges);
                renderChoices(aiResponse.choices);

            } catch (error) {
                console.error("Error handling player action:", error);
                renderNarrative("A chilling sense of uncertainty grips you, as if the world itself is refusing to respond. (Error communicating with the game server. Check console for details.)");
                renderChoices([]);
            } finally {
                toggleLoading(false);
            }
        }

        // --- UI RENDERING ---
        const storyTextElement = document.getElementById('story-text');
        const choicesElement = document.getElementById('choices');
        const loadingIndicator = document.getElementById('loading-indicator');

        function renderNarrative(text) {
            let i = 0;
            storyTextElement.innerHTML = "";
            function typeWriter() {
                if (i < text.length) {
                    storyTextElement.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(typeWriter, 15);
                }
            }
            typeWriter();
        }

        function renderChoices(choices) {
            choicesElement.innerHTML = '';
            if (!choices) return;

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice.text;
                button.onclick = () => {
                    handlePlayerAction(choice.action);
                };
                choicesElement.appendChild(button);
            });
        }
        
        function toggleLoading(isLoading) {
            loadingIndicator.style.display = isLoading ? 'block' : 'none';
            choicesElement.style.display = isLoading ? 'none' : 'flex';
        }

        // --- GAME INITIALIZATION ---
        const startLocations = [
            { id: 'UNIVERSITY_GREENHOUSE', text: "university greenhouse" },
            { id: 'AQUIFER_BUNKER', text: "deep underground bunker" },
            { id: 'COASTAL_RIG', text: "repurposed offshore rig" }
        ];

        function initializeGame() {
            Object.assign(gameState, JSON.parse(JSON.stringify(initialGameState)));
            gameState.character.gender = Math.random() < 0.5 ? 'man' : 'woman';
            gameState.character.age = Math.floor(Math.random() * (75 - 35 + 1)) + 35;
            handlePlayerAction('INITIALIZE_GAME');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('save-button').addEventListener('click', () => saveGame());
        document.getElementById('load-button').addEventListener('click', () => loadGame());
        document.getElementById('restart-button').addEventListener('click', () => restartGame());

        // --- START THE GAME ---
        if (localStorage.getItem('greenFugitiveSave_auto')) {
             loadGame(true);
        } else {
            initializeGame();
        }
    </script>
</body>
</html>
